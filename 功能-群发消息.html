<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/ullist.css" />
    <link rel="stylesheet" href="css/msgicon.css" />
    <title>功能-群发消息</title>
  </head>

  <body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
      <div class="layui-header">
        <div class="layui-logo">
          <img src="images/logo.png" alt="" class="img" />
        </div>
        <div class="head_right clearfix">
          <div class="top_notice fl">
            <span class="fz">新建群发</span>
            <div class="txt">
              <li>这里是功能介绍这里是功能介绍这里是功能介绍</li>
            </div>
          </div>
          <!--<div class="top_wz fl">
                <em class="c_blue">567</em>（总使用）/ <em class="c_blue">2000</em>（总端口数）
            </div>-->
          <div class="fr">
            <a href="#" class="r_fz c_blue">查看登陆日志</a>
            <span class="r_fz">xdqy</span>
            <a href="#" class="r_fz c_blue">修改密码</a>
            <span class="quit quits">退出</span>
          </div>
        </div>
      </div>
      <div class="layui-side left_menu_side">
        <div class="layui-side-scroll">
          <ul class="left_menu">
            <li class="item index">
              <a href="#">首页</a>
            </li>
            <li class="item account haschild">
              <a href="#">账号</a>
              <div class="drop">
                <a href="账号-会员管理.html">分组管理</a>
                <a href="账号-账号管理.html">账号管理</a>
                <a href="账号-账号设置.html">账号设置</a>
              </div>
            </li>
            <li class="item friend haschild">
              <a href="#">好友</a>
              <div class="drop">
                <a href="好友管理.html">好友管理</a>
                <a href="好友-加粉任务.html">加粉任务</a>
                <a href="好友分析.html">好友分析</a>
              </div>
            </li>
            <li class="item group haschild">
              <a href="#">群</a>
              <div class="drop">
                <a href="群管-拉群任务.html">批量拉群</a>
                <a href="群管-加群聊天.html">自动群聊</a>
              </div>
            </li>
            <li class="item function haschild cur">
              <a href="#">功能</a>
              <div class="drop">
                <a href="功能-群发消息.html" class="this">群发消息</a>
                <a href="功能-发朋友圈.html">群发朋友圈</a>
                <a href="功能-朋友圈评论.html">朋友圈评论</a>
                <a href="功能-素材管理.html">素材管理</a>
                <a href="#">群发群</a>
              </div>
            </li>
            <li class="item customer haschild">
              <a href="#">客服系统</a>
              <div class="drop">
                <a href="客服-客服管理.html">客服管理</a>
                <a href="客服-聊天设置.html">聊天设置</a>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="layui-body">
        <div class="bd_wrap bg_white">
          <div class="friend_bar clearfix layui-form bg_f4">
            <a href="javascript:;" class="anniu adduserBtn">+添加分组设置</a>
            <button class="button_ico qunfa fr">群发记录</button>
          </div>
          <div class="qg_tit">群发内容</div>
          <div class="template_main">
            <div class="template_bar">
              <span class="lk txt txts">文字</span>
              <span class="lk pics">图片</span>
              <span class="lk voice">语音</span>
              <span class="lk link">链接</span>
            </div>

            <ul class="template_bar msg-list" style="padding:22px">
              <!-- <li>
                    <div class="num">
                      <span>1</span>
                    </div>
                    <div class="details" data-msgtype="text">
                      <div class="text">地方奋斗奋斗过</div>
                    </div><div class="btnbox">
                        <a href="javascript:;" class="lk_ico editname"></a>
                        <a href="javascript:;" class="lk_ico quit"></a>
                    </div>
                  </li> -->
            </ul>
            <div class="friend_btns">
              <button class="button this fastsend">立即群发</button>
              <button class="button">定时群发</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--添加文字-->
    <div class="pop_bg"></div>
    <div class="pop pop_chart pop_chart_msg pop_chart_msg1">
      <h5 class="t_title">添加文字</h5>
      <div class="detail">
        <div class="dialog_box" style="position: relative">
          <textarea
            name=""
            id="demo"
            class="ipt textarea"
            placeholder="请输入..."
          ></textarea>
          <div
            class="positiemoij"
            style="width: 100%;position: absolute;left:0;top: 0;background:#f4f4fc;display: none"
          >
            <div class="expression expression1 one">
              <div class="scroll-wrapper">
                <div class="face-tb">
                  <ul></ul>
                </div>
              </div>
            </div>

            <div class="expression expression2 ">
              <div class="scroll-wrapper">
                <div class="face-tb">
                  <ul></ul>
                </div>
              </div>
            </div>
            <ul class="nextemoij">
              <li>1</li>
              <li>2</li>
            </ul>
          </div>
          <div class="bar clearfix">
            <em class="bq"></em>
            <span class="fz fr frs">还可输入300字，按Enter键换行</span>
          </div>
        </div>
      </div>
      <div class="btns clearfix">
        <button class="button this queding1">确定</button>
        <button class="button cancel">取消</button>
      </div>
    </div>

    <!-- 添加图片 -->
    <div class="pop pop_chart pop_chart_msg pop_chart_msg2">
      <h5 class="t_title">添加图片</h5>

      <div class="detail">
        <div class="dialog_box">
          <div style="padding:20px">
            <input type="file" />
          </div>
          <div class="pic-list">
            <img class="image" src="" height="200" alt="Image preview..." />
          </div>
        </div>
      </div>
      <div class="btns clearfix">
        <button class="button this queding2">确定</button>
        <button class="button cancel">取消</button>
      </div>
    </div>

    <!--添加账号-弹窗-->
    <div class="pop pop_zh pop_qg_adduser">
      <em class="close">&times;</em>
      <div class="t_tit">添加账号</div>
      <div class="detail layui-form">
        <div class="searchbox clearfix">
          <input
            type="text"
            class="ipt ipt_txt fl"
            placeholder="请输入关键词搜索"
          />
          <input type="button" class="ipt ipt_button fr" value="搜索" />
        </div>
        <div class="box clearfix">
          <div class="box_l fl">
            <div class="topbar">
              <em class="fz fl selectaddcolunt"
                ><input
                  type="checkbox"
                  name=""
                  lay-skin="primary"
                  lay-filter="allChooses"/></em
              >全部账号
            </div>
            <div class="bottom showlable">
              <!-- <li>
                <input
                  type="checkbox"
                  name="like1[write]"
                  lay-skin="primary"
                  title=""
                />7.12-(83)
              </li>
              <li>
                <input
                  type="checkbox"
                  name="like1[write]"
                  lay-skin="primary"
                  title=""
                />7.12-(83)
              </li>
              <li>
                <input
                  type="checkbox"
                  name="like1[write]"
                  lay-skin="primary"
                  title=""
                />7.12-(83)
              </li> -->
            </div>
          </div>
          <div class="box_r fr">
            <div class="topbar">已选账号<em class="fz fr">清空</em></div>
            <div class="bottom">
              <li>安琪<em class="delete"></em></li>
              <li>安琪<em class="delete"></em></li>
              <li>安琪<em class="delete"></em></li>
              <li>安琪<em class="delete"></em></li>
              <li>安琪<em class="delete"></em></li>
              <li>安琪<em class="delete"></em></li>
              <li>安琪<em class="delete"></em></li>
            </div>
          </div>
        </div>
        <div class="tips">当前已选账号83个</div>
        <div class="btns clearfix">
          <button class="button this">确定</button>
          <button class="button cancel">取消</button>
        </div>
      </div>
    </div>

    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="layui/layui.js" charset="utf-8"></script>
    <script src="js/common.js" charset="utf-8"></script>
    <script src="js/loginout.js"></script>
    <script src="js/face.js"></script>
    <script>
      layui.use(
        [
          'layer',
          'form',
          'element',
          'table',
          'laydate',
          'laypage',
          'layedit',
          'upload'
        ],
        function() {
          var form = layui.form,
            layer = layui.layer,
            layedit = layui.layedit,
            laydate = layui.laydate,
            upload = layui.upload
          var layedit = layui.layedit

          //群发对象
          form.on('select(category)', function(data) {
            category = data.value
            categoryName = data.elem[data.elem.selectedIndex].text
            console.log(categoryName)
            form.render('select')
          })

          token = localStorage.getItem('token')
          wxid_raw = JSON.parse(localStorage.getItem('wxid_raw'))
          //获取好友微信列表
          friend_wxid = JSON.parse(localStorage.getItem('friend_wxid'))

          //1.点击添加分组设置获取所有分组
          var alllabelgoup = JSON.parse(localStorage.getItem('alllabelgoup'))
          console.log(alllabelgoup)
          var str = ''
          for (var i in alllabelgoup) {
            str += `
      <li>
              <input
                type="checkbox"
                name="${alllabelgoup[i].name}"
                lay-skin="primary"
                title="${alllabelgoup[i].name}"
                value="${alllabelgoup[i].name}"
                lay-filter="messagesetl"
              />(${alllabelgoup[i].count})
            </li>
      `
          }
          $('.showlable').append(str)
          form.render()

          //2.在添加账号分组的时候点击全选

          form.on('checkbox(allChooses)', function(data) {
            var imgArr = []

            var child = $(data.elem)
              .parents('.box_l')
              .find(".showlable input[type='checkbox']")
            //所有的子元素数量
            child.each(function(index, item) {
              console.log(item)
              //console.log(item.checked)
              console.log(data.elem.checked)
              item.checked = data.elem.checked
            })
            form.render('checkbox')
          })

          //3.在添加账号分组的时候单选
          var labelone = []
          form.on('checkbox(messagesetl)', function(data) {
            categorys = data.value
            labelone.push(categorys)
            console.log(labelone)
            form.render('select')

            var sib = $(data.elem)
              .parents('.box_l')
              .find('.showlable input[type="checkbox"]:checked').length

            //总共的数量
            var total = $(data.elem)
              .parents('.box_l')
              .find('.showlable input[type="checkbox"]').length

            if (sib == total) {
              $(data.elem)
                .parents('.box_l')
                .find('.selectaddcolunt input[type="checkbox"]')
                .prop('checked', true)
              form.render()
            } else {
              $(data.elem)
                .parents('.box_l')
                .find('.selectaddcolunt input[type="checkbox"]')
                .prop('checked', false)
              form.render()
            }
          })

          //添加图片
          for (let i = 0; i < friend_wxid.length; i++) {
            $('.dialog_box input').change(function() {
              var preview = document.getElementsByClassName('image')
              var file = document.querySelector('input[type=file]').files[0]
              var reader = new FileReader()

              reader.addEventListener(
                'load',
                function() {
                  preview.src = reader.result
                  var baseimg = reader.result
                  var data =
                    '{"type":' +
                    '"send_img",' +
                    '"wxid":' +
                    '"' +
                    wxid_raw +
                    '",' +
                    '"to_wxid":' +
                    '"' +
                    friend_wxid[i] +
                    '",' +
                    '"img":' +
                    '"' +
                    baseimg +
                    '",' +
                    '"ticket":' +
                    '"' +
                    token +
                    '"' +
                    '}'
                  //console.log(data)
                  $.ajax({
                    type: 'post',
                    url: 'http://192.168.10.177/api.esp',
                    data: data,
                    async: false,
                    dataType: 'json',
                    success: function(msg) {
                      console.log(msg)
                      // if(msg.err_code !== 0){
                      //     continue
                      // }
                    },
                    error: function(err) {
                      console.log(err)
                    }
                  })
                },
                false
              )
              if (file) {
                reader.readAsDataURL(file)
              }
            })
          }

          // //添加文字
          $('.txts').click(function() {
            $('.pop_chart_msg1').show()
            $('.pop_bg').show()

            //表情包
            var count = 0
            $('.bq').click(function() {
              count++
              if (count % 2 == 0) {
                $('.positiemoij').hide()
              } else {
                $('.positiemoij').show()
              }
              var content = $('.textarea').val()

              //输入表情
              $('.positiemoij>.expression li').click(function() {
                console.log(content)
                var name = $(this)
                  .find('i')
                  .get(0)
                  .getAttribute('data-name')
                $('.positiemoij').hide()
                //$content += $(".ipt").val("["+name+"]")
                content += '[' + name + ']'

                console.log(content)
                $('.textarea').val(content)
              })
            })

            var str = ''
            $('.queding1')
              .unbind('click')
              .bind('click', function() {
                //用于获取编辑器内容
                //var layuicontent = layedit.getContent(index)
                //console.log(layuicontent)
                str = `
                <li>
                       <div class="num">
                         <span></span>
                       </div>
                       <div class="details" data-msgtype="text">
                         <div class="text">${$('.textarea').val()}</div>
                     </li>
             `
                $('.msg-list').append(str)
                $('.pop_chart_msg1').hide()
                $('.pop_bg').hide()
                $('.textarea').val('')
              })
          })

          //点击确定的时候
          $('.fastsend').click(function() {
            var mes = $('.msg-list')
              .find('.text')
              .html()
            for (var i in wxid_raw) {
              for (var j in friend_wxid) {
                var data =
                  '{"type":' +
                  '"send_msg",' +
                  '"wxid":' +
                  '"' +
                  wxid_raw[i] +
                  '",' +
                  '"to_wxid":' +
                  '"' +
                  friend_wxid[j] +
                  '",' +
                  '"content":' +
                  '"' +
                  mes +
                  '",' +
                  '"ticket":' +
                  '"' +
                  token +
                  '"' +
                  '}'
                //console.log(data)
                $.ajax({
                  type: 'post',
                  url: 'http://192.168.10.177/api.esp',
                  data: data,
                  dataType: 'json',
                  success: function(msg) {
                    console.log(msg)
                    if (msg.err_code == 0) {
                      layer.msg('群发成功')
                    } else {
                      layer.msg('群发失败')
                    }
                  },
                  error: function(err) {
                    console.log(err)
                  }
                })
              }
            }
          })
        }
      )

      //添加图片
      $('.pics').click(function() {
        $('.pop_chart_msg2').show()
        $('.pop_bg').show()
      })

      //群发记录
      $('.qunfa').click(function() {
        location.href = '功能-群发记录.html'
      })

      //点击弹窗
      $('.adduserBtn').click(function() {
        $('.pop_qg_adduser').show()
        $('.pop_bg').show()
      })

      //控制输入的文字数量
      $('body').delegate(
        '.pop_chart_msg1 .ipt',
        'propertychange input',
        function() {
          if ($(this).length > 0) {
            var $len = $(this).val().length
            var $inputlen = 300 - $len
            $('.pop_chart_msg1 .frs').html(
              '还可输入' + $inputlen + '字，按Enter键换行'
            )
            if ($len >= 300) {
              $(this).val(
                $(this)
                  .val()
                  .substring(0, 300)
              )
              $('.words').html(0)
            }
          } else {
            console.log('未输入')
          }
        }
      )
    </script>
  </body>
</html>
