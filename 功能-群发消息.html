<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/ullist.css">
    <link rel="stylesheet" href="css/msgicon.css">
    <title>功能-群发消息</title>
  </head>

  <body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
      <div class="layui-header">
        <div class="layui-logo">
          <img src="images/logo.png" alt="" class="img" />
        </div>
        <div class="head_right clearfix">
          <div class="top_notice fl">
            <span class="fz">新建群发</span>
            <div class="txt">
              <li>这里是功能介绍这里是功能介绍这里是功能介绍</li>
            </div>
          </div>
          <!--<div class="top_wz fl">
                <em class="c_blue">567</em>（总使用）/ <em class="c_blue">2000</em>（总端口数）
            </div>-->
          <div class="fr">
            <a href="#" class="r_fz c_blue">查看登陆日志</a>
            <span class="r_fz">xdqy</span>
            <a href="#" class="r_fz c_blue">修改密码</a>
            <span class="quit quits">退出</span>
          </div>
        </div>
      </div>
      <div class="layui-side left_menu_side">
        <div class="layui-side-scroll">
          <ul class="left_menu">
            <li class="item index">
              <a href="#">首页</a>
            </li>
            <li class="item account haschild">
              <a href="#">账号</a>
              <div class="drop">
                <a href="账号-会员管理.html">会员管理</a>
                <a href="账号-账号管理.html">账号管理</a>
                <a href="账号-账号设置.html">账号设置</a>
              </div>
            </li>
            <li class="item friend haschild">
              <a href="#">好友</a>
              <div class="drop">
                <a href="好友管理.html">好友管理</a>
                <a href="好友-加粉任务.html">加粉任务</a>
                <a href="好友分析.html">好友分析</a>
              </div>
            </li>
            <li class="item group haschild">
              <a href="#">群</a>
              <div class="drop">
                <a href="#">批量拉群</a>
                <a href="#">自动群聊</a>
              </div>
            </li>
            <li class="item function haschild cur">
              <a href="#">功能</a>
              <div class="drop">
                <a href="功能-群发消息.html" class="this">群发消息</a>
                <a href="功能-发朋友圈.html">群发朋友圈</a>
                <a href="功能-朋友圈评论.html">朋友圈评论</a>
                <a href="功能-素材管理.html">素材管理</a>
              </div>
            </li>
            <li class="item customer haschild">
              <a href="#">客服系统</a>
              <div class="drop">
                <a href="客服-客服管理.html">客服管理</a>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="layui-body">
        <div class="bd_wrap bg_white">
          <div class="friend_bar clearfix layui-form bg_f4">
            <div class="selectbox">
              <select name="" id="">
                <option value="1">群发对象</option>
                <option value="2">群发对象</option>
                <option value="3">群发对象</option>
              </select>
            </div>
            <button class="button_ico qunfa fr">群发记录</button>
          </div>
          <div class="qg_tit">群发内容</div>
          <div class="template_main">
            <div class="template_bar">
              <span class="lk txt txts">文字</span>
              <span class="lk pics">图片</span>
              <span class="lk voice">语音</span>
              <span class="lk link">链接</span>
            </div>

            <ul class="template_bar msg-list" style="padding:22px">
                <!-- <li>
                    <div class="num">
                      <span>1</span>
                    </div>
                    <div class="details" data-msgtype="text">
                      <div class="text">地方奋斗奋斗过</div>
                    </div><div class="btnbox">
                        <a href="javascript:;" class="lk_ico editname"></a>
                        <a href="javascript:;" class="lk_ico quit"></a>
                    </div>
                  </li> -->
            </ul>
            <div class="friend_btns">
              <button class="button this">立即群发</button>
              <button class="button">定时群发</button>
            </div>
          </div>
        </div>
      </div>
    </div>

        <!--添加文字-->
        <div class="pop_bg"></div>
        <div class="pop pop_chart pop_chart_msg pop_chart_msg1">
          <h5 class="t_title">添加文字</h5>
          <div class="detail">
              <div class="dialog_box">
                  <textarea name="" id="demo" class="ipt textarea" placeholder="请输入..."></textarea>
                  <div class="bar clearfix">
                      <em class="bq"></em>
                      <span class="fz fr frs">还可输入300字，按Enter键换行</span>
                      
                  </div>
              </div>
          </div>
          <div class="btns clearfix">
              <button class="button this queding1">确定</button>
              <button class="button cancel">取消</button>
          </div>
      </div>
    
      <!-- 添加图片 -->
      <div class="pop pop_chart pop_chart_msg pop_chart_msg2">
        <h5 class="t_title">添加图片</h5>
        
        <div class="detail">
            <div class="dialog_box">
                <div style="padding:20px"> 
                    <input type="file">
                </div>
                <div class="pic-list">
                    <img class="image" src="" height="200" alt="Image preview...">
                </div>
            </div>
        </div>
        <div class="btns clearfix">
            <button class="button this queding2">确定</button>
            <button class="button cancel">取消</button>
        </div>
    </div>

  

    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="layui/layui.js" charset="utf-8"></script>
    <script src="js/common.js" charset="utf-8"></script>
    <script src="js/loginout.js"></script>
    <script>
      layui.use([
          'layer',
          'form',
          'element',
          'table',
          'laydate',
          'laypage',
          'layedit',
          'upload'
        ], function() {
        var form = layui.form,
          layer = layui.layer,
          layedit = layui.layedit,
          laydate = layui.laydate,
          upload = layui.upload
          var layedit = layui.layedit

          //用于layui的富文本编辑
          // layedit.build('demo') //建立编辑器
          // var index = layedit.build('demo', {
          //   tool: ['face']
          // })


      token = localStorage.getItem("token")
      wxid_raw = localStorage.getItem("wxid_raw")
      //获取好友微信列表
      friend_wxid =JSON.parse(localStorage.getItem("friend_wxid"))

      for(let i = 0; i< friend_wxid.length; i++){

        $(".dialog_box input").change(function(){
          var preview = document.getElementsByClassName('image');
            var file    = document.querySelector('input[type=file]').files[0];
            var reader  = new FileReader();
  
            reader.addEventListener("load", function () {
              
              preview.src = reader.result;
              var baseimg = reader.result
              var data =
                '{"type":' +
                '"send_img",' +
                '"wxid":' +
                '"'+wxid_raw+'",' +
                '"to_wxid":' +
                '"'+friend_wxid[i]+'",' +
                '"img":' +
                '"'+baseimg+'",' +
                '"ticket":' +
                '"'+token+'"' +
                '}'
                //console.log(data)
                $.ajax({
                      type: 'post',
                      url: 'http://192.168.10.177/api.esp',
                      data:data,
                      async:false,
                      dataType: 'json',
                      success:function(msg){
                          console.log(msg)
                          // if(msg.err_code !== 0){
                          //     continue
                          // }
                      },
                      error:function(err){
                          console.log(err)
                      }
                  })
            }, false);
            if (file) {
              reader.readAsDataURL(file);
            }
          
        })
       
      }  
    


      // //添加文字
       $('.txts').click(function(){
           $('.pop_chart_msg1').show();
           $('.pop_bg').show();
           var str = ""
           $(".queding1").unbind("click").bind("click",function(){
             //用于获取编辑器内容
            //var layuicontent = layedit.getContent(index)
           //console.log(layuicontent)
             str = `
             <li>
                     <div class="num">
                       <span></span>
                     </div>
                     <div class="details" data-msgtype="text">
                       <div class="text">${$(".textarea").val()}</div>
                     </div><div class="btnbox">
                         <a href="javascript:;" class="lk_ico editname"></a>
                         <a href="javascript:;" class="lk_ico quit"></a>
                     </div>
                   </li>
             `
             $(".msg-list").append(str)
             $('.pop_chart_msg1').hide();
             $('.pop_bg').hide();
             $(".textarea").val("")
           })

        }); 

      })

      //添加图片
      $('.pics').click(function(){
          $('.pop_chart_msg2').show();
          $('.pop_bg').show();
      }); 

      //控制输入的文字数量
      $("body").delegate(".pop_chart_msg1 .ipt","propertychange input",function(){
          if($(this).length > 0){
              var $len = $(this).val().length
              var $inputlen = 300-$len;
              $(".pop_chart_msg1 .frs").html("还可输入"+$inputlen +"字，按Enter键换行")
              if($len >= 300){ 
                  $(this).val($(this).val().substring(0,300));    
                  $(".words").html(0)
              }
          }else{
              console.log("未输入")
          }
      })
    
    </script>
  </body>
</html>
