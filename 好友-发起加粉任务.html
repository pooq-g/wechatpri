<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="css/style.css" />
    <title>好友-发起加粉任务</title>
    <style>
      #filetxt {
        position: relative;
      }
      #filetxt input {
        display: inline-block;
        width: 120px;
        height: 30px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        filter: Alpha(opacity=0);
        -webkit-filter: Alpha(opacity=0);
      }
    </style>
  </head>

  <body class="layui-layout-body">
    <div class="layui-layout layui-layout-admin">
      <div class="layui-header">
        <div class="layui-logo">
          <img src="images/logo.png" alt="" class="img" />
        </div>
        <div class="head_right clearfix">
          <div class="top_notice fl">
            <span class="fz">发起加粉任务</span>
            <div class="txt">
              <li>这里是全站公告这里是全站公告这里是全站公告</li>
            </div>
          </div>
          <div class="fr">
            <a href="#" class="r_fz c_blue">查看登陆日志</a>
            <span class="r_fz">xdqy</span>
            <a href="#" class="r_fz c_blue">修改密码</a>
            <span class="quit quits">退出</span>
          </div>
        </div>
      </div>
      <div class="layui-side left_menu_side">
        <div class="layui-side-scroll">
          <ul class="left_menu">
            <li class="item index">
              <a href="#">首页</a>
            </li>
            <li class="item account haschild">
              <a href="#">账号</a>
              <div class="drop">
                <a href="账号-会员管理.html">分组管理</a>
                <a href="账号-账号管理.html">账号管理</a>
                <a href="账号-账号设置.html">账号设置</a>
              </div>
            </li>
            <li class="item friend haschild cur">
              <a href="#">好友</a>
              <div class="drop">
                <a href="好友管理.html">好友管理</a>
                <a href="好友-加粉任务.html">加粉任务</a>
                <a href="好友分析.html">好友分析</a>
              </div>
            </li>
            <li class="item group haschild">
              <a href="#">群</a>
              <div class="drop">
                <a href="群管-拉群任务.html">批量拉群</a>
                <a href="群管-新建群聊.html">自动群聊</a>
              </div>
            </li>
            <li class="item function haschild">
              <a href="#">功能</a>
              <div class="drop">
                <a href="功能-群发消息.html">群发消息</a>
                <a href="功能-发朋友圈.html">群发朋友圈</a>
                <a href="功能-朋友圈评论.html">朋友圈评论</a>
                <a href="功能-素材管理.html">素材管理</a>
                <a href="#">群发群</a>
              </div>
            </li>
            <li class="item customer haschild">
              <a href="#">客服系统</a>
              <div class="drop">
                <a href="客服-客服管理.html">客服管理</a>
                <a href="客服-聊天设置.html">聊天设置</a>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div class="layui-body">
        <div class="friend_bar layui-form clearfix">
          <li class="item fl">
            账号：
            <div class="selectbox layui-input-block" style="margin-left:0">
              <select
                name="category"
                lay-filter="category"
                aria-invalid="false"
                id=""
              >
                <option value="">全部分组</option>
                <option value="1">全部分组</option>
                <option value="2">全部分组</option>
              </select>
            </div>
          </li>
          <button class="button_ico backlist fr">返回列表</button>
        </div>
        <div class="qg_tit">发布任务</div>
        <div class="qg_main bg_white layui-form">
          <div class="addfen_top">
            <h6 class="friend_tit">1.上传加分数据<单次最多可导入2万条数据></h6>
            <div class="fileup_box">
              <span class="fz">上传TXT文件</span>
              <div class="fileup">
                <button
                  type="button"
                  class="layui-btn-normal button"
                  id="filetxt"
                >
                  <input type="file" id="files" />
                  选择文件
                </button>
                <button type="button" class="layui-btn-normal button addtagBtn">
                  选择标签
                </button>
                <span> 添加成功后自动打标签</span>
              </div>
            </div>
            <div class="addfen_tip">
              格式：一行一个微信号、以回车隔开，每行字符数不能超过50.
            </div>
          </div>
          <div class="friend_text">
            <textarea
              name=""
              class="ipt textarea textarea1"
              placeholder="格式1：手机号&nbsp;&nbsp;格式2：手机号#验证信息"
            ></textarea>
            <div class="bar center">
              <span class="words totalphone">共：0条</span>
            </div>
          </div>
          <div class="addfen_from">
            <h6 class="friend_tit">2.设置来源</h6>
            <div class="radio_group">
              <li>
                <div class="grp">
                  <input
                    type="radio"
                    name="from"
                    value="通过手机号搜索"
                    title="通过手机号搜索"
                    checked=""
                    lay-filter="tongguo"
                  />
                </div>
              </li>
              <li>
                <div class="grp">
                  <input
                    type="radio"
                    name="from"
                    value="通过通讯录添加"
                    title="通过通讯录添加"
                    lay-filter="tongguo"
                  />
                </div>
              </li>
              <li>
                <div class="grp">
                  <input
                    type="radio"
                    name="from"
                    value="通过微信号添加"
                    title="通过微信号添加"
                    lay-filter="tongguo"
                  />
                </div>
              </li>
            </div>
          </div>
          <div class="addfen_test">
            <h6 class="friend_tit">3.验证信息</h6>
            <div class="friend_text">
              <textarea
                name=""
                class="ipt textarea textarea2"
                placeholder="请输入验证信息（如果加粉数据是格式2.此验证信息无效）"
              ></textarea>
              <div class="bar layui-form">
                <span class="words">[昵称] [自己昵称] [对方名字]</span>
                <!-- <span class="addtag addtagBtn">添加标签</span> -->
              </div>
            </div>
          </div>

          <div class="addfen_setting">
            <h6 class="friend_tit">4.高级设置</h6>
            <div class="timebox">
              任务执行时间&nbsp;&nbsp;
              <div class="time">
                <div class="layui-inline">
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      class="layui-input"
                      id="test1"
                      placeholder=" - "
                    />
                  </div>
                </div>
              </div>
              <!-- <em class="line">——</em>
              <div class="time">
                <input
                  type="text"
                  class="layui-input"
                  id="test2"
                  placeholder=""
                  readonly
                />
              </div> -->
            </div>
            <div class="txt">
              <p class="fz">（每日加粉任务在指定时间内执行）</p>
              <p class="fz">
                当日加粉频繁次数达到
                <input type="text" class="ipt num" value="3" />次，停止加粉 -
                加粉频繁第<input
                  type="text"
                  class="ipt num"
                  value="1"
                />次后，暂停加粉一次
              </p>
            </div>
          </div>

          <div class="friend_btns">
            <button class="button this filetxtBtn">提交托管加粉</button>
          </div>
          <div class="addfen_tip">
            托管粉说明：提交托管加粉后，系统会每日自动下单加粉，用户只需要在订单明细中查看加粉详情
          </div>
        </div>
      </div>
    </div>

    <!--选择标签-->
    <div class="pop_bg"></div>
    <div class="pop pop_zh pop_hy_edittag">
      <em class="close">&times;</em>
      <div class="t_tit">选择标签</div>
      <div class="detail layui-form">
        <div class="box box1">
          <!-- <li class="grp">
            <input
              type="radio"
              name="tag"
              value="测试"
              title="测试"
              lay-filter="messageset"
            />
          </li>
              <li class="grp">
            <input
              type="radio"
              name="tag"
              value="123"
              title="123"
              lay-filter="messageset"
            />
          </li>
          <li class="grp">
            <input
              type="radio"
              name="tag"
              value="啊啊"
              title="啊啊"
              lay-filter="messageset"
            />
          </li> -->
        </div>
        <span class="addbq">+新建标签 </span>
        <div class="btns clearfix">
          <button class="button this fl quedingfl">确定</button>
          <button class="button fr cancel">取消</button>
        </div>
      </div>
    </div>

    <!--新建标签-->
    <div class="pop pop_zh pop_hy_addtag pop_hy_addtag1">
      <em class="close">&times;</em>
      <div class="t_tit">新建标签</div>
      <div class="detail layui-form">
        <div class="box box2">
          <li>
            <input type="text" class="ipt ipt_txt" />
          </li>
        </div>
        <div class="btns clearfix">
          <button class="button this fl fl1">确定</button>
          <button class="button fr cancel">取消</button>
        </div>
      </div>
    </div>

    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="layui/layui.js" charset="utf-8"></script>
    <script src="js/common.js" charset="utf-8"></script>
    <script src="js/loginout.js"></script>
    <script>
      layui.use(['layer', 'form', 'upload', 'laydate'], function() {
        var form = layui.form,
          layer = layui.layer,
          layedit = layui.layedit,
          laydate = layui.laydate,
          upload = layui.upload

        //时间范围
        laydate.render({
          elem: '#test1',
          type: 'time',
          format: 'HH',
          range: true,
          min: '7:00:00',
          max: '23:00:00',
          btns: ['clear', 'confirm'],
          change: function(value, date, endDate) {
            console.log(value)
            //console.log(value.split(' - '))
            value = value.split(' - ')

            localStorage.setItem('starttime', JSON.stringify(value))
          }
        })
        // laydate.render({
        //   elem: '#test2',
        //   type: 'time',
        //   format: 'HH',
        //   min: '7:00:00',
        //   max: '23:00:00',
        //   btns: ['clear', 'confirm'],
        //   change: function(value, date, endDate) {
        //     console.log(value)
        //     localStorage.setItem('endtime', value)
        //   }
        // })

        //判断手机分组是否存在
        var phonelabelgoup = []
        if (localStorage.getItem('phonelabelgoup')) {
          phonelabelgoup = JSON.parse(localStorage.getItem('phonelabelgoup'))
        } else {
          phonelabelgoup = {}
        }

        var str = ''
        for (var i in phonelabelgoup) {
          str += `
          <li class="grp">
            <input
              type="radio"
              name="tag"
              value="${phonelabelgoup[i].name}"
              title="${phonelabelgoup[i].name}"
              lay-filter="messageset"
            />
          </li> 
                        `
        }
        $('.box1').append(str)
        form.render('radio')

        token = localStorage.getItem('token')
        wxid_raw = JSON.parse(localStorage.getItem('wxid_raw'))

        $('.fl1').click(function() {
          var $id = $('.ipt_txt').val()
          console.log($id)
          console.log(phonelabelgoup)
          if (!phonelabelgoup[$id]) {
            phonelabelgoup[$id] = {}
          }
          phonelabelgoup[$id].name = $id
          localStorage.setItem('phonelabelgoup', JSON.stringify(phonelabelgoup))

          $('.pop_hy_addtag1').hide()
          $('.pop_hy_edittag').show()
          form.render('radio')
          location.reload()
        })

        //点击下拉框选择
        form.on('select(category)', function(data) {
          category = data.value
          categoryName = data.elem[data.elem.selectedIndex].text
          console.log(categoryName)
          form.render('select')

          //选择标签
          form.on('radio(messageset)', function(data) {
            var labelradio = data.value
            console.log(labelradio)

            //上传手机号
            var files = document.getElementById('files')
            files.onchange = function() {
              var file = files.files[0]
              var reader = new FileReader()
              reader.readAsText(file, 'gb2312') //后面的参数是防止中文乱码
              reader.onload = function() {
                //console.log(reader.result)
                $('.textarea1').val(reader.result)
                var str = reader.result
                //读取到的文档数据
                //console.log(str)
                var nstr = str.split('\n')
                //对数据进行换行符分割
                console.log(nstr.length)
                $('.totalphone').html('共：' + nstr.length + '条')
                for (var j in nstr) {
                  var data =
                    '{"type":' +
                    '"upload_phone",' +
                    '"phone":' +
                    '"' +
                    nstr[j] +
                    '",' +
                    '"content":' +
                    '"' +
                    0 +
                    '",' +
                    '"lable":' +
                    '"' +
                    labelradio +
                    '",' +
                    '"ticket":' +
                    '"' +
                    token +
                    '"' +
                    '}'
                  //拿到的传入的参数
                  console.log(data)
                  $.ajax({
                    type: 'post',
                    url: 'http://192.168.10.177/api.esp',
                    data: data,
                    dataType: 'json',
                    success: function(msg) {
                      console.log(msg)
                      if (msg.err_code == 0) {
                        layer.msg('上传成功')
                      } else {
                        layer.msg('上传失败')
                      }
                    },
                    error: function(err) {
                      console.log(err)
                    }
                  })
                }
              }
            }

            //点击爆粉
            $('.filetxtBtn').click(function() {
              var matnnum = Math.floor(Math.random() * 5 + 10)
              var starttime = JSON.parse(localStorage.getItem('starttime'))
              for (var i in wxid_raw) {
                var data =
                  '{"type":' +
                  '"add_phone",' +
                  '"wxid":' +
                  '"' +
                  wxid_raw[i] +
                  '",' +
                  '"num":' +
                  '"10",' +
                  '"time1":' +
                  '"' +
                  starttime[0] +
                  '",' +
                  '"time2":' +
                  '"' +
                  starttime[1] +
                  '",' +
                  '"lable":' +
                  '"' +
                  labelradio +
                  '",' +
                  '"ticket":' +
                  '"' +
                  token +
                  '"' +
                  '}'

                //传入参数
                //console.log(data)
                $.ajax({
                  type: 'post',
                  url: 'http://192.168.10.177/api.esp',
                  data: data,
                  dataType: 'json',
                  success: function(msg) {
                    console.log(msg)
                    if (msg.err_code == 0) {
                      layer.msg('爆粉成功')
                    } else {
                      layer.msg('爆粉失败')
                    }
                  },
                  error: function(err) {
                    console.log(err)
                  }
                })
              }
            })
          })
        })

        //中间单选框的值
        form.on('radio(tongguo)', function(data) {
          console.log(data.value)
        })
      })
      //点击选择标签
      $('.addtagBtn').click(function() {
        $('.pop_hy_edittag').show()
        $('.pop_bg').show()
      })
      //点击新建标签
      $('.addbq').click(function() {
        $('.pop_bg').show()
        $('.pop_hy_addtag1').show()
        $('.pop_hy_edittag').hide()
      })

      $('.quedingfl').click(function() {
        $('.pop_hy_edittag').hide()
        $('.pop_bg').hide()
      })

      //正则表达式
      // $('#test1').blur(function() {
      //   var val = $(this).val()
      //   if (/^\d{2}$/.test(val) == false) {
      //     layer.msg('请输入整数')
      //     $(this).val('')
      //   }
      // })
      // $('#test2').blur(function() {
      //   var val = $(this).val()
      //   if (/^\d{2}$/.test(val) == false) {
      //     layer.msg('请输入整数')
      //     $(this).val('')
      //   }
      // })

      $('.backlist').click(function() {
        history.back()
      })
    </script>
  </body>
</html>
